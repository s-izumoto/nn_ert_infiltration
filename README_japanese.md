# ERT — 土壌への水浸透 + ニューラル補完

> OpenFOAM による物理ベースのシミュレーションと LSTM/Seq2Seq モデルを組み合わせ、**土壌への水浸透中の見かけ比抵抗場**を高解像度・時系列的に再構成します。

---

## 要約 (TL;DR)
- **目的:** 合成データで学習したニューラルネットワークを用いて、**土壌への水浸透**過程の ERT 監視における空間的・時間的ギャップを補完すること。  
- **ワークフロー:** OpenFOAM → 抵抗率マップ → pyGIMLi（Wenner-alpha）→ 測定設計 → LSTM 学習・推論。  
- **使用スクリプト:** `01_generateAppRes.py` ～ `10_comparePredAndNorm.py`。  
- **設定:** すべてのスクリプトは YAML 設定ファイルを使用（コマンドライン引数で上書き可能）。

---

## プロジェクト構成
> 最終的な可視化結果（アニメーションやサマリー）は `movies/` フォルダーに保存されます。

```
├── scripts/
│   ├── 01_generateAppRes.py        # 見かけ比抵抗マップを計算（pyGIMLi, Wenner–alpha）
│   ├── 02_uniteTriangular.py       # 各シーケンスの三角行列を統合して学習／テストセットを作成
│   ├── 03_generateMeasDesign.py    # 真値と測定値の差分が最大の位置を測定点として選定
│   ├── 04_generateTrainingData.py  # 選定された測定位置に基づき測定データスタックを生成
│   ├── 05_trainingSequence.py      # LSTM（Seq2Seq）を時系列差分に対して学習
│   ├── 06_inferSequence.py         # 学習済みモデルを用いて Δ シリーズを予測
│   ├── 07_trainingFirst.py         # 初期導電率マップ再構成用モデルを学習
│   ├── 08_inferFirst.py            # 初期導電率マップを推論
│   ├── 09_inferWhole.py            # 初期値と Δ シリーズを統合し全時系列を再構成
│   ├── 10_comparePredAndNorm.py    # 予測値と測定値を共通カラースケールで比較
│   └── XX_*.py                     # 補助スクリプト（動画変換、描画、バッチ処理など）
├── configs/                        # 各段階の YAML 設定ファイル
├── movies/                         # 出力されたアニメーション（GIF / MP4）
├── .gitignore
└── README.md
```

---

## 測定条件
- **電極数:** 32 本  
- **電極間隔:** 4 cm  
- **測定パターン:** Wenner-alpha（本コード内で使用されるものと同一）  
- **浸潤条件:** 土壌表面中央 30 cm を **0.0885 mol/L NaCl** 溶液で常時飽和状態に維持  
- **ニューラル強化:** ニューラルネットワークにより、元の ERT サンプリングに比べ**時間／空間分解能が約15倍向上**

---

## インストール方法
> Notebook と大容量データは含まれていません。OpenFOAM から得られた導電率マップを `data/` に配置してください。

```bash
conda create -n ert-nn python=3.10 -y
conda activate ert-nn
pip install numpy scipy matplotlib pyyaml tqdm pillow
pip install torch --index-url https://download.pytorch.org/whl/cpu   # GPUがある場合はCUDA版を使用
pip install pygimli
```

環境をエクスポートまたは共有する場合:
```bash
conda env export --no-builds > environment.yml
# 復元する場合
conda env create -f environment.yml
```

---

## 一連のパイプライン（各ステップが**生成するもの**）
以下は、各スクリプトの目的と主な出力の簡潔で正確な説明です。

1) **01_generateAppRes.py — 順解析による三角行列生成**  
   **目的:** OpenFOAM で得た 2D 導電率マップから pyGIMLi（Wenner-alpha, 32電極, 4 cm間隔）を用いて見かけ比抵抗を算出。必要に応じてノイズ付与や三角形状（29, 26, 23, …, 1）への整形を行う。  
   **入力:** 時系列導電率または比抵抗フィールド `(N, T, H, W)`  
   **出力:** **三角形見かけ比抵抗スタック**（シーケンスごと）および**プレビュー画像（任意）**

2) **02_uniteTriangular.py — 学習／テストデータの統合**  
   **目的:** 各シーケンスの三角行列をまとめ、形状を確認したうえで**学習**と**テスト**に分割（固定乱数種も可能）。  
   **入力:** 各シーケンスの三角行列。  
   **出力:** **統合済み4次元データセット（train/test）** と **インデックスリスト（任意）**

3) **03_generateMeasDesign.py — 動的測定設計**  
   **目的:** 各時刻で |真値 − 測定値| を計算し、最大差の位置（top-k=1）を測定点として選択。進行画像やログも出力可能。  
   **入力:** 統合データセット（真の抵抗率マップ）。  
   **出力:** **時間ごとの測定位置インデックス**、およびそれに基づく**測定データスタック**、**可視化フレーム（任意）**

4) **04_generateTrainingData.py — 代表シーケンスを用いた再構成**  
   **目的:** 複数候補の測定シーケンスから1つを選び（中央値または固定）、**同じ測定位置**で学習・テスト両スタックを再生成。  
   **入力:** 真値スタック（train/test）と測定位置シーケンス。  
   **出力:** **測定スタック（train/test）** および **選択されたシーケンスID**

5) **05_trainingSequence.py — 時系列差分用 LSTM (Seq2Seq)**  
   **目的:** 連続時刻間の差分 (Δ) フィールドを予測するエンコーダ・デコーダ LSTM を学習。k-fold 検証、MSE 損失、CSV ログや損失曲線の保存に対応。  
   **入力:** エンコーダ入力シーケンスとデコーダターゲット（平坦化済み三角ベクトル）。  
   **出力:** **学習済みモデル**, **訓練／検証ログ**, **損失プロット**

6) **06_inferSequence.py — Δシリーズの推論**  
   **目的:** 学習済みモデル（および正規化情報）を用いて **自己回帰的 Δ シリーズ**を生成。PNG可視化も可能。  
   **入力:** 測定スタック、チェックポイント、正規化ファイル。  
   **出力:** **予測 Δ 時系列スタック** と **可視化結果（任意）**

7) **07_trainingFirst.py — 初期フレーム回帰（値スケール）**  
   **目的:** スパースな測定シーケンスから初期導電率マップ (t=0, 1000/ρ) を再構成するモデルを学習。k-fold、正規化、平均センタリング対応。  
   **入力:** 前処理済み測定シーケンスと真の初期値（平坦化三角ベクトル）。  
   **出力:** **初期フレーム回帰モデル**, **正規化統計**, **訓練ログ／プロット**

8) **08_inferFirst.py — 初期フレームの推論**  
   **目的:** 学習済みモデルを用いて初期導電率マップ (1000/ρ) を予測し、可視化または保存。  
   **入力:** 測定シーケンス、チェックポイント、正規化ファイル（任意）。  
   **出力:** **初期フレーム予測スタック**, **比較図**

9) **09_inferWhole.py — 全時系列の再構成（値）**  
   **目的:** 予測された初期フレームと Δ シリーズを統合して **完全な導電率シーケンス** を再構成。MAPE の算出や比較画像も生成可能。  
   **入力:** 予測 Δ シリーズ、予測初期フレーム、真値（検証用）。  
   **出力:** **再構成された導電率時系列データ**, **誤差要約**, **比較画像**

10) **10_comparePredAndNorm.py — 予測 vs 測定の統合可視化**  
   **目的:** 予測・測定スタックを共通単位に変換し、無効値を NaN で置換、共通または固定カラースケールで並列表示。  
   **入力:** 予測スタック `(N, T, H, W)`、測定スタック `(N, T, H, W)`  
   **出力:** **シーケンスごとの比較パネル**、**一括出力（任意）**

---

## データ仕様
- **Wenner-alpha 三角行列:** 行サイズ `[29, 26, 23, …, 2, 1]`、NaN 埋め。  
- **配列形状:** 真値／測定スタックは `(N, T, H, W)`。  
- **単位:** 導電率 = `1000 / ρ`。ゼロ値と NaN 処理を実装済み。

---

## トラブルシューティング
- **形状不一致（例：(30,155) vs (29,155)）:** 差分計算時に最初のフレームを除外していないか確認。  
- **ゼロ割り／無限大:** 安全な変換と `nan_fill_value` の設定を使用。  
- **カラースケールの不一致:** 比較スクリプトで共通カラースケールを使用。

---

## ライセンス
プロジェクトルートの `LICENSE` ファイルに、選択したライセンス（例：MIT）を記載してください。
